# 移动端手势操作指南

本文档介绍 LB_FATE.Mobile 中实现的智能手势操作系统。

## 🎮 操作模式

系统支持多种交互模式：

### 1. 普通模式 (Normal)
- **默认状态**，无选中单位
- 点击地图 → 填充命令到输入框

### 2. 移动模式 (Move)
- 选中自己的单位后进入
- 显示蓝色高亮移动范围
- 点击空格直接移动

### 3. 攻击模式 (Attack)
- 选中单位后点击敌人
- 显示红色高亮攻击范围
- 直接发送攻击命令

### 4. 技能模式 (CastSkill)
- 点击"技能"按钮输入技能名
- 显示金色高亮范围
- 点击目标释放技能

## 👆 手势交互流程

### 基础操作

#### 🟢 移动操作
```
1. 点击自己的单位（绿色）
   → 单位被选中（显示绿色指示器）
   → 显示蓝色移动范围

2. 点击空格（高亮范围内）
   → 自动发送 "move x y"
   → 取消选中状态
```

#### 🔴 攻击操作
```
方式1 - 直接攻击:
1. 点击敌人单位（红色）
   → 填充 "attack 敌人ID" 到输入框
2. 点击发送按钮

方式2 - 选中后攻击:
1. 点击自己的单位
2. 点击敌人
   → 自动发送 "attack 敌人ID"
   → 取消选中状态
```

#### 🟣 技能释放
```
1. 点击"技能"按钮
2. 输入技能名称（如: "火球术"）
3. 点击敌人目标
   → 自动发送 "cast 火球术 敌人ID"
   → 取消选中状态
```

#### 🔵 查看单位信息
```
- 点击自己 → 填充 "info"
- 点击发送按钮查看详情
```

### 快捷按钮

| 按钮 | 功能 | 说明 |
|------|------|------|
| **info** | 查看信息 | 显示当前单位详情 |
| **pass** | 结束回合 | 跳过当前回合 |
| **取消** 🟠 | 取消选中 | 清除选中状态和高亮 |
| **技能** 🟣 | 技能模式 | 输入技能名并选择目标 |
| **缩放** 🔵 | 缩放视图 | 放大/缩小地图 |
| **退出** ⚫ | 退出游戏 | 返回主菜单 |

## 🎨 视觉反馈

### 单位颜色
- 🟢 **绿色** - 当前玩家
- 🔵 **蓝色** - 友军
- 🔴 **红色** - 敌军

### 选中指示器
- **绿色圆环** - 选中的单位
- **四角标记** - 选中单位的边框

### 高亮范围
- 🔵 **蓝色半透明** - 可移动范围
- 🔴 **红色半透明** - 可攻击范围
- 🟡 **金色半透明** - 技能施放范围

### 生命值条
- 🟩 **绿色** - HP > 60%
- 🟧 **橙色** - HP 30-60%
- 🟥 **红色** - HP < 30%

## 📱 操作示例

### 示例1: 移动到指定位置

**传统方式**:
```
1. 在输入框输入: move 10 5
2. 点击发送
```

**手势方式**:
```
1. 点击自己的单位（绿色圆圈）
2. 点击目标空格（10, 5）
   ✅ 自动执行移动
```

### 示例2: 攻击敌人

**传统方式**:
```
1. 在输入框输入: attack E1
2. 点击发送
```

**手势方式 (推荐)**:
```
1. 点击自己的单位
2. 点击敌人 E1
   ✅ 自动执行攻击
```

### 示例3: 释放技能

**传统方式**:
```
1. 在输入框输入: cast 火球术 E1
2. 点击发送
```

**手势方式**:
```
1. 点击"技能"按钮
2. 输入: 火球术
3. 点击敌人 E1
   ✅ 自动释放技能
```

### 示例4: 取消操作

**场景**: 不小心选中了单位，想取消

**方法1**: 点击"取消"按钮 (🟠)
**方法2**: 点击空白区域（非高亮范围）

## ⚙️ 配置选项

### 启用/禁用直接操作

在 `GameViewModel` 中：

```csharp
EnableDirectAction = true;  // 启用直接执行（默认）
EnableDirectAction = false; // 仅填充命令到输入框
```

### 自定义移动范围

在 `SelectUnit` 方法中修改：

```csharp
// 当前: 曼哈顿距离 3 格
if (Math.Abs(dx) + Math.Abs(dy) <= 3)

// 改为: 欧几里得距离 5 格
if (Math.Sqrt(dx*dx + dy*dy) <= 5)
```

## 🔧 技术细节

### 交互状态管理

```csharp
public class InteractionState
{
    public InteractionMode Mode { get; set; }
    public GridUnit? SelectedUnit { get; set; }
    public string? CurrentSkill { get; set; }
    public List<(int x, int y)> HighlightedCells { get; set; }
}
```

### 操作流程

1. **用户点击地图** → `GridBoardView.CellTapped` 事件
2. **传递给 ViewModel** → `GameViewModel.OnGridCellTapped(x, y, unit)`
3. **判断交互模式** → 执行相应操作
4. **更新视觉反馈** → 刷新 `InteractionState`
5. **发送命令** → `NetworkService.SendCommandAsync()`

### 关键方法

| 方法 | 功能 |
|------|------|
| `SelectUnit(unit)` | 选中单位，计算可操作范围 |
| `DeselectUnit()` | 取消选中，清除状态 |
| `ExecuteMove(x, y)` | 执行移动命令 |
| `ExecuteAttack(id)` | 执行攻击命令 |
| `ExecuteSkill(skill, id)` | 执行技能命令 |
| `RefreshInteractionState()` | 刷新UI显示 |

## 📊 操作对比

| 操作 | 传统输入 | 手势操作 | 节省步骤 |
|------|---------|---------|----------|
| 移动 | 输入命令 + 发送 | 点2次 | 50% ⬇️ |
| 攻击 | 输入命令 + 发送 | 点2次 | 50% ⬇️ |
| 技能 | 输入命令 + 发送 | 点3次 | 33% ⬇️ |

## 🐛 故障排除

### 问题1: 点击无响应
**原因**: 可能未正确绑定 `InteractionState`
**解决**: 确认 XAML 中有 `InteractionState="{Binding InteractionState}"`

### 问题2: 高亮不显示
**原因**: `HighlightedCells` 未正确计算
**解决**: 检查 `SelectUnit` 方法中的范围计算逻辑

### 问题3: 命令未发送
**原因**: `NetworkService` 为 null
**解决**: 确保已连接服务器，检查 `IsConnected` 状态

### 问题4: 取消按钮无效
**原因**: 状态未刷新
**解决**: 调用 `RefreshInteractionState()` 触发UI更新

## 🔮 未来增强

- [ ] 添加拖拽移动（按住拖动）
- [ ] 范围技能预览（显示AOE范围）
- [ ] 路径寻找可视化
- [ ] 多点触控支持（缩放/旋转）
- [ ] 手势录制回放
- [ ] 自定义手势设置

## 💡 最佳实践

1. **先选中，再操作** - 点击自己 → 点击目标（推荐）
2. **使用取消按钮** - 避免误操作
3. **技能模式** - 批量释放同一技能时更高效
4. **缩放功能** - 精确点击小单位时使用

---

**文档更新**: 2025-10-01
**版本**: v1.0
